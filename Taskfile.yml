version: '3'

vars:
  IMAGE_NAME: blog
  IMAGE_TAG: latest
  CONTAINER_NAME: blog
  PORT: 8090
  REGISTRY: container-registry.wiloon.com
  # Ê†πÊçÆÊìç‰ΩúÁ≥ªÁªüËá™Âä®ÈÄâÊã©ÂÆπÂô®Â∑•ÂÖ∑
  CONTAINER_CMD:
    sh: |
      if [ "{{OS}}" = "darwin" ]; then
        echo "colima nerdctl --"
      else
        echo "sudo nerdctl"
      fi

tasks:
  default:
    desc: Show all available tasks
    cmds:
      - task --list-all
    silent: true

  help:
    desc: Show help information
    cmds:
      - task --list
    silent: true

  build:
    desc: Build container image (amd64)
    cmds:
      - '{{.CONTAINER_CMD}} build --platform linux/amd64 --progress=plain -t {{.IMAGE_NAME}}:{{.IMAGE_TAG}} -f Containerfile .'
      - '{{.CONTAINER_CMD}} tag {{.IMAGE_NAME}}:{{.IMAGE_TAG}} {{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}}'
      - echo "‚úÖ Image built {{.IMAGE_NAME}}:{{.IMAGE_TAG}}"
      - echo "‚úÖ Image tagged {{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}}"

  push:
    desc: Push image to container registry
    cmds:
      - '{{.CONTAINER_CMD}} push {{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}}'
      - echo "‚úÖ Image pushed to {{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}}"

  build-push:
    desc: Build and push image to registry
    deps: [build, push]
    cmds:
      - echo "‚úÖ Build and push completed"

  run:
    desc: Run container
    deps: [stop]
    cmds:
      - '{{.CONTAINER_CMD}} run -d --name {{.CONTAINER_NAME}} --network host {{.IMAGE_NAME}}:{{.IMAGE_TAG}}'
      - echo "‚úÖ Container started at http://localhost:80"

  stop:
    desc: Stop and remove container
    cmds:
      - '{{.CONTAINER_CMD}} stop {{.CONTAINER_NAME}} 2>/dev/null || true'
      - '{{.CONTAINER_CMD}} rm {{.CONTAINER_NAME}} 2>/dev/null || true'
    silent: true

  restart:
    desc: Restart container (rebuild and run)
    deps: [stop, build, run]
    cmds:
      - echo "‚úÖ Restart completed"

  logs:
    desc: View container logs
    cmds:
      - '{{.CONTAINER_CMD}} logs -f {{.CONTAINER_NAME}}'

  shell:
    desc: Enter container shell
    cmds:
      - '{{.CONTAINER_CMD}} exec -it {{.CONTAINER_NAME}} sh'

  ps:
    desc: View container status
    cmds:
      - |
        if [ "{{OS}}" = "darwin" ]; then
          {{.CONTAINER_CMD}} ls | grep {{.CONTAINER_NAME}} || echo "‚ùå Container not running"
        else
          {{.CONTAINER_CMD}} ps -a | grep {{.CONTAINER_NAME}} || echo "‚ùå Container not running"
        fi

  images:
    desc: List images
    cmds:
      - '{{.CONTAINER_CMD}} images | grep -E "REPOSITORY|{{.IMAGE_NAME}}"'

  clean:
    desc: Clean up container and images
    deps: [stop]
    cmds:
      - '{{.CONTAINER_CMD}} rmi {{.IMAGE_NAME}}:{{.IMAGE_TAG}} 2>/dev/null || true'
      - echo "‚úÖ Cleanup completed"

  test:
    desc: Test container health
    cmds:
      - sleep 3
      - curl -f http://localhost:{{.PORT}} && echo "‚úÖ Health check passed" || echo "‚ùå Health check failed"

  dev:
    desc: Development mode (quick restart)
    deps: [stop, build, run]
    cmds:
      - echo "üöÄ Dev mode started, visit http://localhost:{{.PORT}}"

  inspect:
    desc: Inspect image details
    cmds:
      - '{{.CONTAINER_CMD}} inspect {{.IMAGE_NAME}}:{{.IMAGE_TAG}}'

  stats:
    desc: View container resource usage
    cmds:
      - '{{.CONTAINER_CMD}} stats {{.CONTAINER_NAME}}'
