---
title: oracle 存储过程
author: w1100n
type: post
date: 2013-06-27T02:14:47+00:00
url: /?p=5555
categories:
  - DataBase

---
[sql]

create or replace procedure sp\_test(cur\_arg out sys_refcursor
  
) as
  
begin
  
open cur_arg for
  
select serv\_id, serv\_name from itmis\_pri\_serv_tbl where year = 2013;
  
end;

[/sql]

1.基本结构

[sql]

CREATE OR REPLACE PROCEDURE 存储过程名字

(

参数1 IN NUMBER,

参数2 IN NUMBER

) IS

变量1 INTEGER :=0;

变量2 DATE;

BEGIN

DBMS\_OUTPUT.PUT\_LINE('Hello World!');

END;

[/sql]

Hello world

[sql]
  
CREATE OR REPLACE PROCEDURE procPrintHelloWorld
  
IS
  
BEGIN

DBMS\_OUTPUT.PUT\_LINE('Hello World!');

END;
  
[/sql]

Note: 在SQL*PLUS环境中设定如下命令： SQLPLUS> set serveroutput on才能看到DBMS\_OUTPUT.PUT\_LINE的输出


2.SELECT INTO STATEMENT

将select查询的结果存入到变量中，可以同时将多个列存储多个变量中，必须有一条

记录，否则抛出异常(如果没有记录抛出NO\_DATA\_FOUND)

例子：

[sql]

BEGIN

SELECT col1,col2 into 变量1,变量2 FROM typestruct where xxx;

EXCEPTION

WHEN NO\_DATA\_FOUND THEN

xxxx;

END;

...

[/sql]

3.IF 判断

[sql]

IF V_TEST=1 THEN

BEGIN

do something

END;

END IF;

[/sql]

4.while 循环

[sql]

WHILE V_TEST=1 LOOP

BEGIN

XXXX

END;

END LOOP;

[/sql]

5.变量赋值

[sql]

V_TEST := 123;

[/sql]

6.用for in 使用cursor

...

IS

CURSOR cur IS SELECT * FROM xxx;

BEGIN

FOR cur_result in cur LOOP

BEGIN

V\_SUM :=cur\_result.列名1+cur_result.列名2

END;

END LOOP;

END;

7.带参数的cursor

CURSOR C\_USER(C\_ID NUMBER) IS SELECT NAME FROM USER WHERE TYPEID=C_ID;

OPEN C_USER(变量值);

LOOP

FETCH C\_USER INTO V\_NAME;

EXIT FETCH C_USER%NOTFOUND;

do something

END LOOP;

CLOSE C_USER;

8.用pl/sql developer debug

连接数据库后建立一个Test WINDOW

在窗口输入调用SP的代码,F9开始debug,CTRL+N单步调试

关于oracle存储过程的若干问题备忘

1.在oracle中，数据表别名不能加as，如：

select a.appname from appinfo a;- 正确

select a.appname from appinfo as a;- 错误

也许，是怕和oracle中的存储过程中的关键字as冲突的问题吧

2.在存储过程中，select某一字段时，后面必须紧跟into，如果select整个记录，利用游标的话就另当别论了。

select af.keynode into kn from APPFOUNDATION af where af.appid=aid and af.foundationid=fid;- 有into，正确编译

select af.keynode from APPFOUNDATION af where af.appid=aid and af.foundationid=fid;- 没有into，编译报错，提示：Compilation

Error: PLS-00428: an INTO clause is expected in this SELECT statement

3.在利用select...into...语法时，必须先确保数据库中有该条记录，否则会报出"no data found"异常。

可以在该语法之前，先利用select count(*) from 查看数据库中是否存在该记录，如果存在，再利用select...into...

4.在存储过程中，别名不能和字段名称相同，否则虽然编译可以通过，但在运行阶段会报错

select keynode into kn from APPFOUNDATION where appid=aid and foundationid=fid;- 正确运行

select af.keynode into kn from APPFOUNDATION af where af.appid=appid and af.foundationid=foundationid;- 运行阶段报错，提示

ORA-01422:exact fetch returns more than requested number of rows

5.在存储过程中，关于出现null的问题

假设有一个表A，定义如下：

create table A(

id varchar2(50) primary key not null,

vcount number(8) not null,

bid varchar2(50) not null - 外键

);

如果在存储过程中，使用如下语句：

select sum(vcount) into fcount from A where bid='xxxxxx';

如果A表中不存在bid="xxxxxx"的记录，则fcount=null(即使fcount定义时设置了默认值，如：fcount number(8):=0依然无效，fcount还是会变成null)，这样以后使用fcount时就可能有问题，所以在这里最好先判断一下：

if fcount is null then

fcount:=0;

end if;

这样就一切ok了。

6.Hibernate调用oracle存储过程

this.pnumberManager.getHibernateTemplate().execute(

new HibernateCallback() {

public Object doInHibernate(Session session)

throws HibernateException, SQLException {

CallableStatement cs = session

.connection()

.prepareCall("{call modifyapppnumber_remain(?)}");

cs.setString(1, foundationid);

cs.execute();

return null;

}

});


<http://www.cnblogs.com/happyday56/archive/2007/07/05/806830.html>

<http://www.mkyong.com/oracle/oracle-stored-procedures-hello-world-examples/>

http://dacoolbaby.iteye.com/blog/1684549