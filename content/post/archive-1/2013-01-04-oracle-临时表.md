---
title: oracle 临时表
author: wiloon
type: post
date: 2013-01-04T03:38:20+00:00
url: /?p=4968
categories:
  - DataBase

---
###  http://blog.csdn.net/wyzxg/article/details/1882347

<div>
  <p>
    <strong><span style="font-family: Calibri; font-size: medium;">临时表的特点，什么时候用</span></strong><span style="font-family: Calibri; font-size: medium;"> </span><span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-size: medium;">前段时间，新公司的面试官问了一个问题，临时表的作用，以前我们用缓存中间数据时候，都是自己建一个临时表。其实<span style="font-family: Calibri;">oracle</span>本身在这方面就已经考虑很全了，除非有些高级应用，我再考虑自己创建临时表。由于本人对临时表的了解不是很多，于是回来搜集下这方面的资料，弥补下这块的不足。</span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;"><span style="font-family: Calibri; font-size: medium;">1</span>、前言</span><span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">    </span>目前所有使用<span style="font-family: Calibri;">Oracle</span>作为数据库支撑平台的应用，大部分数据量比较庞大的系统，即表的数据量一般情况下都是在百万级以上的数据量。</span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;"><span style="font-family: Calibri; font-size: medium;">    </span>当然在<span style="font-family: Calibri; font-size: medium;">Oracle</span>中创建分区是一种不错的选择，但是当你发现你的应用有多张表关联的时候，并且这些表大部分都是比较庞大，而你关联的时候发现其中的某一张或者某几张表关联之后得到的结果集非常小并且查询得到这个结果集的速度非常快，那么这个时候我考虑在<span style="font-family: Calibri; font-size: medium;">Oracle</span>中创建“临时表”。</span><span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;"> </span>我对临时表的理解：在<span style="font-family: Calibri;">Oracle</span>中创建一张表，这个表不用于其他的什么功能，主要用于自己的软件系统一些特有功能才用的，而当你用完之后表中的数据就没用了。<span style="font-family: Calibri;">Oracle</span>的临时表创建之后基本不占用表空间，如果你没有指定临时表（包括临时表的索引）存放的表空的时候，你插入到临时表的数据是存放在<span style="font-family: Calibri;">ORACLE</span>系统的临时表空间中（<span style="font-family: Calibri;">TEMP</span>）。</span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;"> </span><span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-family: 宋体;">2、临时表的创建</span>
  </p>
  
  <p>
    <span style="font-family: 宋体;">创建Oracle临时表，可以有两种类型的临时表：</span>
  </p>
  
  <p>
    <strong><span style="font-family: 宋体;">会话级的临时表</span></strong>
  </p>
  
  <p>
    <span style="font-family: 宋体;"><strong>事务级的临时表</strong>。</span>
  </p>
  
  <p>
    <span style="font-family: 宋体;">1）</span> <span style="font-family: 宋体;">会话级的临时表因为这这个临时表中的数据和你的当前会话有关系，当你当前SESSION不退出的情况下，临时表中的数据就还存在，而当你退出当前SESSION的时候，临时表中的数据就全部没有了，当然这个时候你如果以另外一个SESSION登陆的时候是看不到另外一个SESSION中插入到临时表中的数据的。即两个不同的SESSION所插入的数据是互不相干的。当某一个SESSION退出之后临时表中的数据就被截断（truncate table，即数据清空）了。会话级的临时表创建方法：</span>
  </p>
  
  <p>
    [sql]
  </p>
  
  <p>
    Create Global Temporary Table Table_Name
  </p>
  
  <p>
    (Col1 Type1,Col2 Type2&#8230;) <strong>On Commit Preserve Rows</strong>；
  </p>
  
  <p>
    &#8211;举例：
  </p>
  
  <p>
    create global temporary table Student
  </p>
  
  <p>
    (Stu_id Number(5),
  </p>
  
  <p>
    Class_id  Number(5),
  </p>
  
  <p>
    Stu_Name Varchar2(8),
  </p>
  
  <p>
    Stu_Memo varchar2(200)) on Commit Preserve Rows;
  </p>
  
  <p>
    [/sql]
  </p>
  
  <p>
    <span style="font-family: 宋体;" data-mce-mark="1">2）</span> <span style="font-family: 宋体;" data-mce-mark="1">事务级临时表是指该临时表与事务相关，当进行事务提交或者事务回滚的时候，临时表中的数据将自行被截断，其他的内容和会话级的临时表的一致（包括退出SESSION的时候，事务级的临时表也会被自动截断）。事务级临时表的创建方法：</span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;">3）</span>  <span style="font-size: medium;">两中类型临时表的区别</span>
  </p>
  
  <p>
    <span style="font-size: medium;"><strong>会话级临时表采用</strong><strong>on commit preserve rows</strong><strong>；而事务级则采用</strong><strong>on commit delete rows</strong><strong>；用法上，会话级别只有当会话结束临时表中的数据才会被截断，而且事务级临时表则不管是</strong><strong>commit</strong><strong>、</strong><strong>rollback</strong><strong>或者是会话结束，临时表中的数据都将被截断</strong></span>
  </p>
  
  <p>
    <strong><span style="font-size: medium;"> </span></strong>
  </p>
  
  <p>
    [sql]
  </p>
  
  <p>
    Create Global Temporary Table Table_Name
  </p>
  
  <p>
    (Col1 Type1,Col2 Type2&#8230;) On Commit Delete Rows；
  </p>
  
  <p>
    &#8211;举例：
  </p>
  
  <p>
    create global temporary table Classes
  </p>
  
  <p>
    (Class_id Number(5),
  </p>
  
  <p>
    Class_Name Varchar2(8),
  </p>
  
  <p>
    Class_Memo varchar2(200)) on Commit delete Rows ;
  </p>
  
  <p>
    [/sql]
  </p>
  
  <p>
    4）什么时候使用临时表<strong><span style="font-size: medium;"> </span></strong>
  </p>
  
  <p>
    <span style="font-size: medium;">1）、当某一个SQL语句关联的表在2张及以上，并且和一些小表关联。可以采用将大表进行分拆并且得到比较小的结果集合存放在临时表中</span>
  </p>
  
  <p>
    <span style="font-size: medium;">2）、程序执行过程中可能需要存放一些临时的数据，这些数据在整个程序的会话过程中都需要用的等等。</span>
  </p>
  
  <p>
    <strong><span style="font-family: Calibri; font-size: medium;"> </span></strong>
  </p>
  
  <p>
    <strong><span style="font-family: Calibri; font-size: medium;"> </span></strong>
  </p>
  
  <p>
    <span style="font-size: medium;"><strong><span style="font-family: Calibri;">3</span></strong><strong>．</strong>例子：略</span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">4</span>．临时表的不足之处</span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">    1</span>）不支持<span style="font-family: Calibri;">lob</span>对象，这也许是设计者基于运行效率的考虑，但实际应用中确实需要此功能时就无法使用临时表了。</span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">2</span>）不支持主外键关系</span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-size: medium;">所以，由于以上原因，我们可以自己创建临时表，以弥补<span style="font-family: Calibri;">oracle</span>临时表的不足之处</span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-size: medium;">上面的都是本人经过测试的，但下面是在网上搜索到的方法，本人具体没有测试过，不过觉得可行性很强，有时间测试下</span>
  </p>
  
  <p>
    <span style="font-family: Calibri; font-size: medium;"> </span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">   </span>创建方法：</span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">      1</span>、以常规表的形式创建临时数据表的表结构，但要在每一个表的主键中加入一个<span style="font-family: Calibri;"> SessionID <NUMBER> </span>列以区分不同的会话。（可以有<span style="font-family: Calibri;">lob</span>列和主外键）</span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">2</span>、写一个用户注销触发器，在用户结束会话的时候删除本次会话所插入的所有记录<span style="font-family: Calibri;">(SessionID</span>等于本次会话<span style="font-family: Calibri;">ID</span>的记录<span style="font-family: Calibri;">)</span>。</span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">3</span>、程序写入数据时，要顺便将当前的会话<span style="font-family: Calibri;">ID(SessionID)</span>写入表中。</span>
  </p>
  
  <p>
    <span style="font-size: medium;"><span style="font-family: Calibri;">4</span>、程序读取数据时，只读取与当前会话<span style="font-family: Calibri;">ID</span>相同的记录即可。</span>
  </p>
  
  <p>
    <span style="font-family: 宋体;"><span style="font-size: medium;">   <strong>功能增强的扩展设计：</strong></span></span><strong>
 </strong><span style="font-family: 宋体; font-size: medium;">　</span><span style="font-family: 宋体;">　1、可以在数据表上建立一个视图，视图对记录的筛选条件就是当前会话的SessionID。</span>
 <span style="font-family: 宋体;">　　2、数据表中的SessionID列可以通过Trigger实现，以实现对应用层的透明性。</span>
 <span style="font-family: 宋体;">　　3、高级用户可以访问全局数据，以实现更加复杂的功能。</span>
  </p>
  
  <p>
    <span style="font-family: 宋体;"><span style="font-size: medium;">　　<strong>扩展临时表的优点：</strong></span></span><strong>
 </strong><span style="font-family: 宋体;"><span style="font-size: medium;">　　</span>1</span><span style="font-family: 宋体;">、实现了与Oracle的基于会话的临时表相同的功能。</span>
 <span style="font-family: 宋体;">　　2、支持SDO_GEOMETRY等lob数据类型。</span>
 <span style="font-family: 宋体;">　　3、支持表间的主外键连接，且主外键连接也是基于会话的。</span>
 <span style="font-family: 宋体;">　　4、高级用户可以访问全局数据，以实现更加复杂的功能</span>
  </p>
</div>