---
title: shiro 标签
author: wiloon
type: post
date: 2013-01-20T03:01:22+00:00
url: /?p=5046
categories:
  - Java
  - Web

---
<http://kdboy.iteye.com/blog/1155450>

授权即访问控制，它将判断用户在应用程序中对资源是否拥有相应的访问权限。
  
如，判断一个用户有查看页面的权限，编辑数据的权限，拥有某一按钮的权限，以及是否拥有打印的权限等等。

**一、授权的三要素**

授权有着三个核心元素：权限、角色和用户。

**权限**
  
权限是Apache Shiro安全机制最核心的元素。它在应用程序中明确声明了被允许的行为和表现。一个格式良好好的权限声明可以清晰表达出用户对该资源拥有的权限。
  
大多数的资源会支持典型的CRUD操作（create,read,update,delete）,但是任何操作建立在特定的资源上才是有意义的。因此，权限声明的根本思想就是建立在资源以及操作上。
  
而我们通过权限声明仅仅能了解这个权限可以在应用程序中做些什么，而不能确定谁拥有此权限。
  
于是，我们就需要在应用程序中对用户和权限建立关联。
  
通常的做法就是将权限分配给某个角色，然后将这个角色关联一个或多个用户。

**权限声明及粒度**
  
Shiro权限声明通常是使用以冒号分隔的表达式。就像前文所讲，一个权限表达式可以清晰的指定资源类型，允许的操作，可访问的数据。同时，Shiro权限表达式支持简单的通配符，可以更加灵活的进行权限设置。
  
下面以实例来说明权限表达式。
  
可查询用户数据
  
User:view
  
可查询或编辑用户数据
  
User:view,edit
  
可对用户数据进行所有操作
  
User:* 或 user
  
可编辑id为123的用户数据
  
User:edit:123

**角色**
  
Shiro支持两种角色模式：
  
1、传统角色：一个角色代表着一系列的操作，当需要对某一操作进行授权验证时，只需判断是否是该角色即可。这种角色权限相对简单、模糊，不利于扩展。
  
2、权限角色：一个角色拥有一个权限的集合。授权验证时，需要判断当前角色是否拥有该权限。这种角色权限可以对该角色进行详细的权限描述，适合更复杂的权限设计。
  
下面将详细描述对两种角色模式的授权实现。

**二、授权实现**

Shiro支持三种方式实现授权过程：

  * 编码实现
  * 注解实现
  * JSP Taglig实现

**1、基于编码的授权实现**

**1.1基于传统角色授权实现**
  
当需要验证用户是否拥有某个角色时，可以调用Subject 实例的hasRole*方法验证。

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      Subject currentUser = SecurityUtils.getSubject();
    </li>
    <li>
      if (currentUser.hasRole("administrator")) {
    </li>
    <li>
          //show the admin button
    </li>
    <li>
      } else {
    </li>
    <li>
          //don't show the button?  Grey it out?
    </li>
    <li>
      }
    </li>
  </ol>

相关验证方法如下：

<table>
  <tr>
    <td>
      Subject方法
    </td>
    
    <td>
      描述
    </td>
  </tr>
  
  <tr>
    <td>
      hasRole(String roleName)
    </td>
    
    <td>
      当用户拥有指定角色时，返回true
    </td>
  </tr>
  
  <tr>
    <td>
      hasRoles(List<String> roleNames)
    </td>
    
    <td>
      按照列表顺序返回相应的一个boolean值数组
    </td>
  </tr>
  
  <tr>
    <td>
      hasAllRoles(Collection<String> roleNames)
    </td>
    
    <td>
      如果用户拥有所有指定角色时，返回true
    </td>
  </tr>
</table>

**断言支持**
  
Shiro还支持以断言的方式进行授权验证。断言成功，不返回任何值，程序继续执行；断言失败时，将抛出异常信息。使用断言，可以使我们的代码更加简洁。

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      Subject currentUser = SecurityUtils.getSubject();
    </li>
    <li>
      //guarantee that the current user is a bank teller and
    </li>
    <li>
      //therefore allowed to open the account:
    </li>
    <li>
      currentUser.checkRole("bankTeller");
    </li>
    <li>
      openBankAccount();
    </li>
  </ol>

断言的相关方法：

<table>
  <tr>
    <td>
      Subject方法
    </td>
    
    <td>
      描述
    </td>
  </tr>
  
  <tr>
    <td>
      checkRole(String roleName)
    </td>
    
    <td>
      断言用户是否拥有指定角色
    </td>
  </tr>
  
  <tr>
    <td>
      checkRoles(Collection<String> roleNames)
    </td>
    
    <td>
      断言用户是否拥有所有指定角色
    </td>
  </tr>
  
  <tr>
    <td>
      checkRoles(String... roleNames)
    </td>
    
    <td>
      对上一方法的方法重载
    </td>
  </tr>
</table>

**1.2 基于权限角色授权实现**
  
相比传统角色模式，基于权限的角色模式耦合性要更低些，它不会因角色的改变而对源代码进行修改，因此，基于权限的角色模式是更好的访问控制方式。
  
它的代码实现有以下几种实现方式：
  
**1、基于权限对象的实现**
  
创建org.apache.shiro.authz.Permission的实例，将该实例对象作为参数传递给Subject.isPermitted（）进行验证。

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      Permission printPermission = new PrinterPermission("laserjet4400n", "print");
    </li>
    <li>
      Subject currentUser = SecurityUtils.getSubject();
    </li>
    <li>
      if (currentUser.isPermitted(printPermission)) {
    </li>
    <li>
          //show the Print button
    </li>
    <li>
      } else {
    </li>
    <li>
          //don't show the button?  Grey it out?
    </li>
    <li>
      }
    </li>
    <li>
      Permission printPermission = new PrinterPermission("laserjet4400n", "print");
    </li>
    <li>
      Subject currentUser = SecurityUtils.getSubject();
    </li>
    <li>
      if (currentUser.isPermitted(printPermission)) {
    </li>
    <li>
          //show the Print button
    </li>
    <li>
      } else {
    </li>
    <li>
          //don't show the button?  Grey it out?
    </li>
    <li>
      }
    </li>
  </ol>

相关方法如下：

<table>
  <tr>
    <td>
      Subject方法
    </td>
    
    <td>
      描述
    </td>
  </tr>
  
  <tr>
    <td>
      isPermitted(Permission p)
    </td>
    
    <td>
      Subject拥有制定权限时，返回treu
    </td>
  </tr>
  
  <tr>
    <td>
      isPermitted(List<Permission> perms)
    </td>
    
    <td>
      返回对应权限的boolean数组
    </td>
  </tr>
  
  <tr>
    <td>
      isPermittedAll(Collection<Permission> perms)
    </td>
    
    <td>
      Subject拥有所有制定权限时，返回true
    </td>
  </tr>
</table>

**2、 基于字符串的实现**
  
相比笨重的基于对象的实现方式，基于字符串的实现便显得更加简洁。

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      Subject currentUser = SecurityUtils.getSubject();
    </li>
    <li>
      if (currentUser.isPermitted("printer:print:laserjet4400n")) {
    </li>
    <li>
          //show the Print button
    </li>
    <li>
      } else {
    </li>
    <li>
          //don't show the button?  Grey it out?
    </li>
    <li>
      }
    </li>
  </ol>

使用冒号分隔的权限表达式是org.apache.shiro.authz.permission.WildcardPermission 默认支持的实现方式。
  
这里分别代表了 资源类型：操作：资源ID

类似基于对象的实现相关方法，基于字符串的实现相关方法：
  
isPermitted(String perm)、isPermitted(String... perms)、isPermittedAll(String... perms)

**基于权限对象的断言实现**

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      Subject currentUser = SecurityUtils.getSubject();
    </li>
    <li>
      //guarantee that the current user is permitted
    </li>
    <li>
      //to open a bank account:
    </li>
    <li>
      Permission p = new AccountPermission("open");
    </li>
    <li>
      currentUser.checkPermission(p);
    </li>
    <li>
      openBankAccount();
    </li>
  </ol>

**基于字符串的断言实现**

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      Subject currentUser = SecurityUtils.getSubject();
    </li>
    <li>
      //guarantee that the current user is permitted
    </li>
    <li>
      //to open a bank account:
    </li>
    <li>
      currentUser.checkPermission("account:open");
    </li>
    <li>
      openBankAccount();
    </li>
  </ol>

断言实现的相关方法

<table>
  <tr>
    <td>
      Subject方法
    </td>
    
    <td>
      说明
    </td>
  </tr>
  
  <tr>
    <td>
      checkPermission(Permission p)
    </td>
    
    <td>
      断言用户是否拥有制定权限
    </td>
  </tr>
  
  <tr>
    <td>
      checkPermission(String perm)
    </td>
    
    <td>
      断言用户是否拥有制定权限
    </td>
  </tr>
  
  <tr>
    <td>
      checkPermissions(Collection<Permission> perms)
    </td>
    
    <td>
      断言用户是否拥有所有指定权限
    </td>
  </tr>
  
  <tr>
    <td>
      checkPermissions(String... perms)
    </td>
    
    <td>
      断言用户是否拥有所有指定权限
    </td>
  </tr>
</table>

**2、基于注解的授权实现**
  
Shiro注解支持AspectJ、Spring、Google-Guice等，可根据应用进行不同的配置。

相关的注解：
  
**@ RequiresAuthentication**
  
可以用户类/属性/方法，用于表明当前用户需是经过认证的用户。

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      @RequiresAuthentication
    </li>
    <li>
      public void updateAccount(Account userAccount) {
    </li>
    <li>
          //this method will only be invoked by a
    </li>
    <li>
          //Subject that is guaranteed authenticated
    </li>
    <li>
          ...
    </li>
    <li>
      }
    </li>
  </ol>

**@ RequiresGuest**
  
表明该用户需为"guest"用户

**@ RequiresPermissions**
  
当前用户需拥有制定权限

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      @RequiresPermissions("account:create")
    </li>
    <li>
      public void createAccount(Account account) {
    </li>
    <li>
          //this method will only be invoked by a Subject
    </li>
    <li>
          //that is permitted to create an account
    </li>
    <li>
          ...
    </li>
    <li>
      }
    </li>
  </ol>

**@RequiresRoles**
  
当前用户需拥有制定角色

**@ RequiresUser**
  
当前用户需为已认证用户或已记住用户

**3、基于JSP  TAG的授权实现**
  
Shiro提供了一套JSP标签库来实现页面级的授权控制。
  
在使用Shiro标签库前，首先需要在JSP引入shiro标签：

<div id="">
  
    
      Java代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <%@ taglib prefix="shiro" uri="http://shiro.apache.org/tags" %>
    </li>
  </ol>

下面一一介绍Shiro的标签：
  
guest标签
  
验证当前用户是否为"访客"，即未认证（包含未记住）的用户

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:guest>
    </li>
    <li>
          Hi there!  Please <a href="login.jsp">Login</a> or <a href="signup.jsp">Signup</a> today!
    </li>
    <li>
      </shiro:guest>
    </li>
  </ol>

user标签
  
认证通过或已记住的用户

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:user>
    </li>
    <li>
          Welcome back John!  Not John? Click <a href="login.jsp">here<a> to login.
    </li>
    <li>
      </shiro:user>
    </li>
  </ol>

authenticated标签
  
已认证通过的用户。不包含已记住的用户，这是与user标签的区别所在。

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:authenticated>
    </li>
    <li>
          <a href="updateAccount.jsp">Update your contact information</a>.
    </li>
    <li>
      </shiro:authenticated>
    </li>
  </ol>

notAuthenticated标签
  
未认证通过用户，与authenticated标签相对应。与guest标签的区别是，该标签包含已记住用户。

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:notAuthenticated>
    </li>
    <li>
          Please <a href="login.jsp">login</a> in order to update your credit card information.
    </li>
    <li>
      </shiro:notAuthenticated>
    </li>
  </ol>

principal 标签
  
输出当前用户信息，通常为登录帐号信息

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      Hello, <shiro:principal/>, how are you today?
    </li>
  </ol>

hasRole标签
  
验证当前用户是否属于该角色

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:hasRole name="administrator">
    </li>
    <li>
          <a href="admin.jsp">Administer the system</a>
    </li>
    <li>
      </shiro:hasRole>
    </li>
  </ol>

lacksRole标签
  
与hasRole标签逻辑相反，当用户不属于该角色时验证通过

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:lacksRole name="administrator">
    </li>
    <li>
          Sorry, you are not allowed to administer the system.
    </li>
    <li>
      </shiro:lacksRole>
    </li>
  </ol>

hasAnyRole标签
  
验证当前用户是否属于以下任意一个角色。

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:hasAnyRoles name="developer, project manager, administrator">
    </li>
    <li>
          You are either a developer, project manager, or administrator.
    </li>
    <li>
      </shiro:lacksRole>
    </li>
  </ol>

hasPermission标签
  
验证当前用户是否拥有制定权限

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:hasPermission name="user:create">
    </li>
    <li>
          <a href="createUser.jsp">Create a new User</a>
    </li>
    <li>
      </shiro:hasPermission>
    </li>
  </ol>

lacksPermission标签
  
与hasPermission标签逻辑相反，当前用户没有制定权限时，验证通过

<div id="">
  
    
      Xml代码  <a title="收藏这段代码"><img alt="收藏代码" src="http://kdboy.iteye.com/images/icon_star.png" /></a>
  
  
  <ol start="1">
    <li>
      <shiro:hasPermission name="user:create">
    </li>
    <li>
          <a href="createUser.jsp">Create a new User</a>
    </li>
    <li>
      </shiro:hasPermission>
    </li>
  </ol>
