---
title: gradle 多项目
author: wiloon
type: post
date: 2016-01-20T00:21:51+00:00
url: /?p=8683
categories:
  - Uncategorized

---
1. 创建项目
  
首先创建项目，名称为 test：

mkdir test && cd test
  
gradle init

这时候的项目结构如下：

➜ test tree
  
.
  
├── build.gradle
  
├── gradle
  
│   └── wrapper
  
│   ├── gradle-wrapper.jar
  
│   └── gradle-wrapper.properties
  
├── gradlew
  
├── gradlew.bat
  
└── settings.gradle

2 directories, 6 files

然后，创建多个模块，这里以 core 和 web 模块为例，先创建两个目录：



[shell]

mkdir  core && mkdir web

cd core && gradle init &#8211;type java-library

cd web && gradle init &#8211;type java-library

[/shell]



2. 修改配置
  
接下来修改根目录下的 settings.gradle 文件，引入子模块：

include &#8216;core&#8217;,&#8217;web&#8217;

修改根目录下的 build.gradle：
  
// 所有子项目的通用配置
  
subprojects {
  
apply plugin: &#8216;java&#8217;
  
apply plugin: &#8216;eclipse&#8217;
  
apply plugin: &#8216;idea&#8217;

version = &#8216;1.0&#8217;

// JVM 版本号要求
  
sourceCompatibility = 1.7
  
targetCompatibility = 1.7

// java编译的时候缺省状态下会因为中文字符而失败
  
[compileJava,compileTestJava,javadoc]\*.options\*.encoding = &#8216;UTF-8&#8217;

//定义版本号
  
ext {
  
springVersion = &#8216;3.2.11.RELEASE&#8217;
  
hibernateVersion=&#8217;4.3.1.Final&#8217;
  
}

repositories {
  
mavenCentral()
  
}

jar {
  
manifest {
  
attributes("Implementation-Title&#8221;: "Gradle&#8221;)
  
}
  
}

configurations {
  
// 所有需要忽略的包定义在此
  
all*.exclude group: &#8216;commons-httpclient&#8217;
  
all*.exclude group: &#8216;commons-logging&#8217;
  
all*.exclude group: &#8216;commons-beanutils&#8217;, module: &#8216;commons-beanutils&#8217;
  
}

dependencies {
  
// 通用依赖
  
compile(
  
"org.springframework:spring-context:$springVersion&#8221;,
  
"org.springframework:spring-orm:$springVersion&#8221;,
  
"org.springframework:spring-tx:$springVersion&#8221;,
  
"org.springframework.data:spring-data-jpa:1.5.2.RELEASE&#8221;,
  
"org.hibernate:hibernate-entitymanager:$hibernateVersion&#8221;,
  
"c3p0:c3p0:0.9.1.2&#8221;,
  
"mysql:mysql-connector-java:5.1.26&#8221;,
  
"org.slf4j:slf4j-nop:1.7.6&#8221;,
  
"commons-fileupload:commons-fileupload:1.3.1&#8221;,
  
"com.fasterxml.jackson.core:jackson-databind:2.3.1&#8221;
  
)

// 依赖maven中不存在的jar
  
ext.jarTree = fileTree(dir: &#8216;libs&#8217;, include: &#8216;*\*/\*.jar&#8217;)
  
ext.rootProjectLibs = new File(rootProject.rootDir, &#8216;libs&#8217;).getAbsolutePath()
  
ext.jarTree += fileTree(dir: rootProjectLibs, include: &#8216;*\*/\*.jar&#8217;)

compile jarTree

// 测试依赖
  
testCompile(
  
"org.springframework:spring-test:$springVersion&#8221;,
  
"junit:junit:4.11"
  
)
  
}

// 显示当前项目下所有用于 compile 的 jar.
  
task listJars(description: &#8216;Display all compile jars.&#8217;) << {
  
configurations.compile.each { File file -> println file.name }
  
}
  
}

接下来可以修改 core/build.gradle 来定义 core 模块的依赖：

// jar包的名字
  
archivesBaseName = &#8216;core&#8217;

// 还可以定义其他配置，这里直接继承父模块中的配置

web 模块需要依赖 core 模块，故定义 web/build.gradle 如下：

apply plugin:&#8221;war&#8221;

dependencies{
  
// 依赖 core 模块
  
compile project(":core&#8221;)
  
compile(
  
"org.springframework:spring-webmvc:$springVersion&#8221;,
  
"org.apache.taglibs:taglibs-standard-impl:1.2.1&#8221;
  
)
  
//系统提供的依赖
  
providedCompile(
  
"javax.servlet:javax.servlet-api:3.1.0&#8221;,
  
"javax.servlet.jsp:jsp-api:2.2.1-b03&#8221;,
  
"javax.servlet.jsp.jstl:javax.servlet.jsp.jstl-api:1.2.1&#8221;
  
)
  
}

task jarWithoutResources(type: Jar) {
  
baseName project.name
  
from("$buildDir/classes/main&#8221;)
  
}

war{
  
dependsOn jarWithoutResources
  
from("$projectDir/src/main/resources&#8221;) {
  
include "*.properties&#8221;
  
into("WEB-INF/classes&#8221;)
  
}
  
classpath=classpath &#8211; sourceSets.main.output
  
classpath fileTree(dir:libsDir, include:&#8221;${project.name}-${version}.jar&#8221;)
  
}
  
task(&#8216;jarPath&#8217;)<<{
  
configurations.runtime.resolve().each {
  
print it.toString()+&#8221;;&#8221;
  
}
  
println();
  
}

3. 编译项目
  
查看所有 jar：

$ gradle listJars

查看各个模块的依赖：

$ gradle :core:dependencies
  
$ gradle :web:dependencies

编译所有模块：

$ gradle build

对比一下，这时候的目录如下：

➜ test tree
  
.
  
├── build.gradle
  
├── core
  
│   ├── build
  
│   │   ├── libs
  
│   │   │   └── core-1.0.jar
  
│   │   └── tmp
  
│   │   └── jar
  
│   │   └── MANIFEST.MF
  
│   ├── build.gradle
  
│   └── src
  
│   ├── main
  
│   │   └── java
  
│   └── test
  
│   └── java
  
├── gradle
  
│   └── wrapper
  
│   ├── gradle-wrapper.jar
  
│   └── gradle-wrapper.properties
  
├── gradlew
  
├── gradlew.bat
  
├── settings.gradle
  
└── web
  
├── build
  
│   ├── libs
  
│   │   ├── web-1.0.jar
  
│   │   └── web-1.0.war
  
│   └── tmp
  
│   ├── jarWithoutResources
  
│   │   └── MANIFEST.MF
  
│   └── war
  
│   └── MANIFEST.MF
  
├── build.gradle
  
└── src
  
├── main
  
│   └── java
  
└── test
  
└── java

23 directories, 14 files

这样，core和web模块都是gradle项目了，你也可以单独编译某一个模块，例如，编译core模块：

$ cd core
  
$ rm -rf build
  
$ gradle build
  
$ tree
  
.
  
├── build
  
│   ├── libs
  
│   │   └── core-1.0.jar
  
│   └── tmp
  
│   └── jar
  
│   └── MANIFEST.MF
  
├── build.gradle
  
└── src
  
├── main
  
│   └── java
  
└── test
  
└── java

9 directories, 3 files

4. 一些小技巧
  
1. 善用 gradle dependencies
  
gradle dependencies > depend.log

2. java 编译时候报编码错误
  
[compileJava,compileTestJava,javadoc]\*.options\*.encoding = &#8216;UTF-8&#8217;

3. 忽略掉 .gradle 目录
  
修改 .gitignore 忽略该目录：

*.sw?
  
.#*
  
*#
  
*~
  
.classpath
  
.project
  
.settings
  
bin
  
build
  
target
  
dependency-reduced-pom.xml
  
\*.sublime-\*
  
/scratch
  
.gradle
  
README.html
  
.idea
  
*.iml

4. Maven 库中没有的 jar 该怎么管理
  
在顶级目录增加一个 libs 文件夹，这个文件夹里面的 jar 是对所有项目都起作用的。

如果是某个项目自用的，则可以在该项目的 source 下面创建个 libs，具体实现是在顶级目录下的 build.gradle 中：

ext.jarTree = fileTree(dir: &#8216;libs&#8217;, include: &#8216;*\*/\*.jar&#8217;)
  
ext.rootProjectLibs = new File(rootProject.rootDir, &#8216;libs&#8217;).getAbsolutePath()
  
ext.jarTree += fileTree(dir: rootProjectLibs, include: &#8216;*\*/\*.jar&#8217;)

compile jarTree

5. jar 包定义外移
  
暂时还没有这样的需求，详细说明请参考 jar 包定义外移

6. 如何指定 build 输出目录和版本号
  
buildDir = "target&#8221;
  
version = &#8216;1.0&#8217;

7. 在执行 Gradle 命令时如何指定参数
  
gradle task -P profile=development

8. Gradle 和 idea 集成时如何不自动下载依赖源码和javadoc
  
idea {
  
module {
  
downloadJavadoc = false
  
downloadSources = false
  
}
  
}

5. 参考文章
  
gradle多模块开发
  
Gradle 多项目管理示例
  
构建工具之 &#8211; Gradle一般使用常见问答

http://blog.javachen.com/2015/01/07/build-multi-module-project-with-gradle.html

http://www.blogjava.net/wldandan/archive/2012/07/12/382792.html